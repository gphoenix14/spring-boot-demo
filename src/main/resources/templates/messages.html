<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Messages</title>

<style>
/* ===== LAYOUT PRINCIPALE ===== */
body{font-family:Arial,Helvetica,sans-serif;background:#ece5dd;margin:0}
.container{max-width:600px;margin:40px auto;background:#fff;border-radius:6px;
           box-shadow:0 2px 8px rgba(0,0,0,.15);padding:20px}

/* ===== TOP BAR ===== */
.topbar{display:flex;justify-content:space-between;align-items:center;
        background:#075e54;color:#fff;padding:10px 18px;border-radius:6px 6px 0 0;
        margin:-20px -20px 20px -20px}
.topbar h1{font-size:18px;margin:0;font-weight:600}
.user-info{display:flex;align-items:center;gap:10px;font-size:15px}
.user-info button,.logout-btn{background:#25d366;border:0;padding:6px 10px;border-radius:4px;
                              color:#fff;cursor:pointer;font-size:13px}
.user-info button:hover{background:#1eb05a}

/* logout ‚Äúrosso‚Äù */
.logout-btn{background:#d32f2f}
.logout-btn:hover{background:#b71c1c}

/* ===== FORM / BUBBLES ===== */
.message-form input[type=text],.message-form select{
  width:100%;padding:10px;border:1px solid #ddd;border-radius:4px;margin-bottom:8px}
.message-form button{width:100%;padding:10px;border:0;border-radius:4px;color:#fff;
  background:#25d366;font-weight:bold;cursor:pointer;margin-bottom:6px}

.message-container{margin-top:18px}
.message{max-width:80%;padding:8px 12px;border-radius:8px;font-size:14px;
         line-height:1.4;word-wrap:break-word;position:relative;margin:6px 0}
.sent{background:#dcf8c6;margin-left:auto}
.received{background:#fff}
.broadcast{background:#ffe9a6}

.msg-meta{display:block;font-size:11px;color:#555;margin-bottom:3px}
.delete-btn{background:none;border:0;color:#888;cursor:pointer;font-size:14px;
            position:absolute;top:4px;right:4px}
.delete-btn:hover{color:#d11}

/* ===== MODAL RSA ===== */
#rsaModal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);
          backdrop-filter:blur(2px);z-index:999}
.modal-box{background:#fafafa;width:90%;max-width:520px;margin:10% auto;
           border-radius:6px;padding:18px 20px;box-shadow:0 4px 12px rgba(0,0,0,.25);}
.modal-box h2{margin-top:0;font-size:18px;color:#075e54}
.modal-box textarea{width:100%;height:200px;resize:vertical;border:1px solid #ccc;
                    border-radius:4px;padding:8px;font-family:monospace;font-size:13px}
.modal-box .close{background:#d32f2f;border:0;color:#fff;padding:6px 12px;
                  border-radius:4px;cursor:pointer;margin-top:10px}
.modal-box .close:hover{background:#b71c1c}
</style>
</head>
<body>
<div class="container">

  <!-- ===== TOP BAR ===== -->
  <div class="topbar">
    <h1>Ecampus¬†‚Äì¬†Progetto¬†LdP</h1>

    <div class="user-info">
      <span id="currentUser" th:text="${currentUser}">user</span>

      <!-- LOGOUT -->
      <form id="logoutForm" th:action="@{/logout}" method="post" style="display:inline;margin:0">
        <button type="submit" class="logout-btn">Logout</button>
      </form>

      <button type="button" id="showKey">Show¬†RSA</button>
    </div>
  </div>

  <!-- ===== FORM INVIO ===== -->
  <div class="message-form">
    <form id="sendMsgForm" th:action="@{/messages/send}" method="post">
      <input id="msgContent" type="text" name="content" placeholder="Write a message">
      <button id="sendBroadcastBtn" type="submit" name="sendPrivate" value="false">Send Broadcast</button>

      <select id="receiverSelect" name="receiverUsername">
        <option value="">Select a user</option>
        <option th:each="u : ${users}" th:value="${u.username}" th:text="${u.username}"></option>
      </select>

      <button id="sendPrivateBtn" type="submit" name="sendPrivate" value="true">Send Private</button>
    </form>
  </div>

  <!-- ===== LISTA MESSAGGI ===== -->
  <div class="message-container">
    <div th:each="m : ${messagePage.content}"
         th:class="'message ' +
                   (${m.sender.username} == ${currentUser} ? 'sent' : 'received') +
                   (${m.isBroadcast} ? ' broadcast' : '')"
         th:attr="data-broadcast=${m.isBroadcast},
                  data-ct=${m.content},
                  data-sender=${m.sender.username},
                  data-receiver=${m.receiver != null ? m.receiver.username : ''}">
      <form th:if="${m.sender.username} == ${currentUser}"
            th:action="@{/messages/delete}" method="post" style="display:inline">
        <input type="hidden" name="id" th:value="${m.id}">
        <button class="delete-btn" title="Delete">üóëÔ∏è</button>
      </form>

      <span class="msg-meta"
            th:utext="${#temporals.format(m.timestamp,'dd/MM/yyyy HH:mm')} + ' ' +
                     ${m.sender.username} +
                     (${m.isBroadcast} ? ' ‚Üí tutti' : (' ‚Üí ' + ${m.receiver.username}))">
      </span>
      <span class="msg-body" th:text="${m.content}"></span>
    </div>
  </div>

  <!-- ===== PAGINAZIONE ===== -->
  <div style="margin-top:14px;font-size:14px">
    <a th:if="${messagePage.hasPrevious()}"
       th:href="@{/messages(page=${messagePage.number-1},size=${messagePage.size})}">¬´ Prev</a>
    <a th:if="${messagePage.hasNext()}"
       th:href="@{/messages(page=${messagePage.number+1},size=${messagePage.size})}">Next ¬ª</a>
  </div>
</div>

<!-- ===== MODAL STRUCTURE ===== -->
<div id="rsaModal">
  <div class="modal-box">
    <h2>RSA¬†Private‚ÄØKey</h2>
    <textarea id="rsaTxt" readonly></textarea>
    <button class="close" id="closeModal">Close</button>
  </div>
</div>

<!-- ===== JS ===== -->
<script>
document.addEventListener('DOMContentLoaded', async () => {

  const currentUser = document.getElementById('currentUser').textContent.trim();

  /* ===== modal RSA ===== */
  const modal  = document.getElementById('rsaModal');
  const rsaTxt = document.getElementById('rsaTxt');
  document.getElementById('showKey').onclick = () => {
    const m = document.cookie.match(/(?:^|;\s*)rsaPriv=([^;]+)/);
    if (!m) { alert('No key in cookie'); return; }
    rsaTxt.value = decodeURIComponent(m[1]);
    modal.style.display = 'block';
  };
  document.getElementById('closeModal').onclick = () => modal.style.display = 'none';
  modal.onclick = e => { if (e.target === modal) modal.style.display = 'none'; };

  /* ===== logout: clear rsaPriv & chatKey_* ===== */
  document.getElementById('logoutForm').addEventListener('submit', () => {
    document.cookie = 'rsaPriv=; Path=/; Expires=Thu, 01 Jan 1970 00:00:00 GMT';
    document.cookie.split(';').forEach(c=>{
      const [n] = c.trim().split('=');
      if(n.startsWith('chatKey_')){
        document.cookie = n+'=; Path=/; Expires=Thu, 01 Jan 1970 00:00:00 GMT';
      }
    });
  });

  /* ====================== CHAT‚ÄëKEY CACHE ============================ */
  const aesCache = new Map();   // partner -> Uint8Array(32)

  function b64ToBytes(b64) {
    const bin = atob(b64);
    const arr = new Uint8Array(bin.length);
    for (let i=0;i<bin.length;i++) arr[i] = bin.charCodeAt(i);
    return arr;
  }
  function bytesToUrlB64(u8) {
    let bin = '';
    for (let i=0;i<u8.length;i++) bin += String.fromCharCode(u8[i]);
    return btoa(bin).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
  }
  function urlB64ToStd(b64url) {
    let s = b64url.replace(/-/g,'+').replace(/_/g,'/');
    while (s.length % 4) s += '=';
    return s;
  }

  async function getRsaPrivKey() {
    const m = document.cookie.match(/(?:^|;\s*)rsaPriv=([^;]+)/);
    if (!m) throw new Error('rsaPriv cookie missing');
    const pkcs8 = b64ToBytes(decodeURIComponent(m[1]));
    const algo = {name:'RSA-OAEP',hash:'SHA-256'};
    return crypto.subtle.importKey('pkcs8', pkcs8, algo, false, ['decrypt']);
  }

  function loadAesFromCookie(partner) {
    const re = new RegExp('(?:^|;\\s*)chatKey_'+encodeURIComponent(partner)+'=([^;]+)');
    const m = document.cookie.match(re);
    if (!m) return null;
    const rawArr = b64ToBytes(urlB64ToStd(m[1]));
    aesCache.set(partner, rawArr);
    return rawArr;
  }

  async function getAesKey(partner) {
    if (aesCache.has(partner)) return aesCache.get(partner);
    const fromCookie = loadAesFromCookie(partner);
    if (fromCookie) return fromCookie;

    console.debug('[chat-key] fetch for', partner);
    // server CREA se manca
    const resp = await fetch('/chat-key?partner='+encodeURIComponent(partner));
    if (!resp.ok) throw new Error('chat-key fetch failed: '+resp.status);
    const encKeyB64 = await resp.text(); // RSA‚Äëencrypted AES

    const priv = await getRsaPrivKey();
    const raw  = await crypto.subtle.decrypt({name:'RSA-OAEP'}, priv, b64ToBytes(encKeyB64));
    const rawArr = new Uint8Array(raw);
    aesCache.set(partner, rawArr);

    // cache in cookie (url‚Äësafe)
    document.cookie = 'chatKey_'+encodeURIComponent(partner)+'='+bytesToUrlB64(rawArr)+'; Path=/; Max-Age=3600';
    return rawArr;
  }

  /* ===================== DECRYPT MESSAGGI =========================== */
  function partnerFromDiv(div){
    const s = div.dataset.sender;
    const r = div.dataset.receiver;
    if (!r) return null;              // broadcast
    return (s === currentUser) ? r : s;
  }

  async function decryptDiv(div) {
    if (div.dataset.broadcast === 'true') return;
    const partner = partnerFromDiv(div);
    if (!partner) return;

    try {
      const key = await getAesKey(partner);
      const all = b64ToBytes(urlB64ToStd(div.dataset.ct));
      const iv  = all.slice(0,12);
      const ct  = all.slice(12);
      const cryptoKey = await crypto.subtle.importKey('raw', key, {name:'AES-GCM'}, false, ['decrypt']);
      const ptBuf = await crypto.subtle.decrypt({name:'AES-GCM',iv}, cryptoKey, ct);
      div.querySelector('.msg-body').textContent = new TextDecoder().decode(ptBuf);
    } catch (e) {
      console.error('decrypt msg failed', e);
      div.querySelector('.msg-body').textContent = '[DECRYPT¬†ERROR]';
    }
  }

  document.querySelectorAll('.message').forEach(div => { decryptDiv(div); });

  /* ================= CIFRATURA INVIO PRIVATO ======================== */
  const form         = document.getElementById('sendMsgForm');
  const privBtn      = document.getElementById('sendPrivateBtn');
  const broadBtn     = document.getElementById('sendBroadcastBtn');
  const txtInput     = document.getElementById('msgContent');
  const sel          = document.getElementById('receiverSelect');

  let lastSubmitMode = 'broadcast';
  broadBtn.addEventListener('click', () => { lastSubmitMode='broadcast'; });
  privBtn.addEventListener('click',  () => { lastSubmitMode='private';  });

  form.addEventListener('submit', async ev => {
    if (lastSubmitMode !== 'private') {
      return; // broadcast: submit normale
    }
    ev.preventDefault();

    const receiver = sel.value;
    if (!receiver) { alert('Select a user'); return; }
    const plaintext = txtInput.value.trim();
    if (!plaintext) { alert('Message empty'); return; }

    try {
      const key = await getAesKey(receiver); // crea se manca
      const iv = crypto.getRandomValues(new Uint8Array(12));
      const cryptoKey = await crypto.subtle.importKey('raw', key, {name:'AES-GCM'}, false, ['encrypt']);
      const ctBuf = await crypto.subtle.encrypt({name:'AES-GCM',iv}, cryptoKey, new TextEncoder().encode(plaintext));

      // concat iv + ct
      const raw = new Uint8Array(iv.length + ctBuf.byteLength);
      raw.set(iv,0);
      raw.set(new Uint8Array(ctBuf), iv.length);
      const payload = bytesToUrlB64(raw);

      const fd = new FormData(form);
      fd.set('content', payload);
      fd.set('sendPrivate', 'true');
      fd.set('receiverUsername', receiver);

      const resp = await fetch('/messages/send', {method:'POST', body:fd});
      if (!resp.ok) {
        alert('Errore invio messaggio: '+resp.status);
        return;
      }
      txtInput.value='';
      window.location.href='/messages';
    } catch (e) {
      console.error('private send failed', e);
      alert('Errore durante la cifratura / invio del messaggio privato.');
    }
  });
});
</script>


</body>
</html>
